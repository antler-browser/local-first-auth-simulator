<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local First Auth Simulator - Functional Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }

        .info {
            max-width: 600px;
            margin: 0 auto 20px;
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .info h1 {
            margin: 0 0 16px;
            color: #2c3e50;
            font-size: 28px;
        }

        .info p {
            margin: 12px 0;
            color: #555;
            line-height: 1.6;
        }

        .info ul {
            margin: 12px 0;
            padding-left: 24px;
            color: #555;
            line-height: 1.8;
        }

        .info ul li {
            margin: 6px 0;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px 16px;
            border-radius: 4px;
            color: #856404;
            margin: 16px 0;
        }

        .code {
            background: #f7f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            padding: 10px 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            color: #0066cc;
            margin: 8px 0;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 12px 16px;
            border-radius: 4px;
            color: #155724;
            margin: 16px 0;
        }

        kbd {
            background: #f7f9fa;
            border: 1px solid #d1d5da;
            border-radius: 3px;
            padding: 3px 6px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="info">
        <h1>Local First Auth Simulator - Functional Test</h1>

        <div class="warning">
            <strong>Before opening this file:</strong><br>
            You must build the bundled version first:
            <div class="code">npm run build:bundle</div>
        </div>

        <div class="success" id="status">
            <strong>Status:</strong> Initializing...
        </div>

        <p><strong>What this page tests:</strong></p>
        <ul>
            <li><strong>Debug UI Panel</strong> - Should appear in bottom-left corner</li>
            <li><strong>Get Profile Details</strong> - Returns signed JWT with profile info</li>
            <li><strong>Get Avatar</strong> - Returns signed JWT with avatar data</li>
            <li><strong>Get App Details</strong> - Returns app metadata</li>
            <li><strong>Profile Disconnected Event</strong> - Sends disconnect message</li>
            <li><strong>Close WebView</strong> - Triggers close and shows alert</li>
        </ul>

        <p><strong>How to test:</strong></p>
        <ol style="color: #555; line-height: 1.8; padding-left: 24px;">
            <li>Look for the debug panel in the bottom-left corner</li>
            <li>Open browser console (F12) to see detailed output</li>
            <li>Click each button in the debug panel</li>
            <li>Verify console logs show expected results</li>
            <li>Try keyboard shortcut: <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>D</kbd> to toggle panel</li>
        </ol>

        <p style="margin-top: 16px;"><strong>Console Output:</strong></p>
        <p style="color: #666; font-size: 14px;">All button clicks and API results will be logged to the browser console. Press <strong>F12</strong> to open Developer Tools.</p>
    </div>

    <script type="module">
        // Import the bundled simulator
        import { enableLocalFirstAuthSimulator } from './dist-bundle/index.mjs';

        try {
            // Initialize the simulator with debug UI enabled
            const simulator = enableLocalFirstAuthSimulator({
                showDebugUI: true,
                networkDelayMs: 100,
                appDetails: {
                    name: 'Local First Auth Simulator',
                    version: '1.0.0',
                    platform: 'ios',
                    supportedPermissions: ['profile']
                }
            });

            // Update status
            document.getElementById('status').innerHTML =
                '<strong>Status:</strong> Simulator initialized successfully! Debug panel should be visible.';

            console.log('═══════════════════════════════════════');
            console.log('Local First Auth Simulator - Functional Test');
            console.log('═══════════════════════════════════════');
            console.log('Simulator initialized successfully');
            console.log('');
            console.log('Current Profile:');
            console.log(simulator.getCurrentProfile());
            console.log('');
            console.log('window.localFirstAuth API is available:');
            console.log(window.localFirstAuth);
            console.log('');
            console.log('Click the buttons in the debug panel to test functionality!');
            console.log('   All API calls and events will be logged here.');
            console.log('═══════════════════════════════════════');

            // Listen for window messages (disconnect events, etc.)
            window.addEventListener('message', (event) => {
                console.log('');
                console.log('Message Event Received:');
                console.log('   Origin:', event.origin);
                console.log('   Data:', event.data);

                if (event.data?.jwt) {
                    console.log('   JWT received in message event');
                }

                console.log('═══════════════════════════════════════');
            });

            // Test window.localFirstAuth methods are available
            console.log('');
            console.log('Testing API Method Availability:');
            console.log('   - getProfileDetails:', typeof window.localFirstAuth?.getProfileDetails === 'function' ? 'OK' : 'MISSING');
            console.log('   - getAvatar:', typeof window.localFirstAuth?.getAvatar === 'function' ? 'OK' : 'MISSING');
            console.log('   - getAppDetails:', typeof window.localFirstAuth?.getAppDetails === 'function' ? 'OK' : 'MISSING');
            console.log('   - requestPermission:', typeof window.localFirstAuth?.requestPermission === 'function' ? 'OK' : 'MISSING');
            console.log('   - close:', typeof window.localFirstAuth?.close === 'function' ? 'OK' : 'MISSING');

        } catch (error) {
            console.error('Failed to initialize simulator:', error);
            document.getElementById('status').innerHTML =
                '<strong>Error:</strong> Failed to initialize. Check console for details.';
            document.getElementById('status').style.background = '#f8d7da';
            document.getElementById('status').style.borderColor = '#dc3545';
            document.getElementById('status').style.color = '#721c24';
        }
    </script>
</body>
</html>
